name: ğŸ” Generate KubeVela Schemas

# ==============================================================================
# TRIGGERS
# ==============================================================================
on:
  workflow_dispatch:
    inputs:
      commit_schemas:
        description: 'Commit generated schemas back to the repo?'
        type: boolean
        default: true
      debug_mode:
        description: 'Enable extra verbose Dagger output (--progress=plain)?'
        type: boolean
        default: true
  push:
    branches:
      - main
    paths:
      - '.ci/**'

# ==============================================================================
# PERMISSIONS â€” needed so the bot can push the generated schemas back
# ==============================================================================
permissions:
  contents: write

# ==============================================================================
# JOBS
# ==============================================================================
jobs:
  generate-schemas:
    name: ğŸš€ Extract & Generate KubeVela Schemas
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # --------------------------------------------------------------------------
      # 1. Checkout
      # --------------------------------------------------------------------------
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------------------------
      # 2. Go toolchain (matches .ci/go.mod)
      # --------------------------------------------------------------------------
      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: .ci/go.sum

      # --------------------------------------------------------------------------
      # 3. Install Doppler CLI
      # --------------------------------------------------------------------------
      - name: ğŸ”‘ Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      # --------------------------------------------------------------------------
      # 4. Install Dagger CLI â€” pinned to match .ci/dagger.json
      # --------------------------------------------------------------------------
      - name: âš™ï¸ Install Dagger CLI (v0.19.11)
        run: |
          curl -fsSL https://dl.dagger.io/dagger/install.sh | \
            BIN_DIR=/usr/local/bin DAGGER_VERSION=0.19.11 sh
          echo "Dagger version: $(dagger version)"

      # --------------------------------------------------------------------------
      # 5. Show which secrets Doppler will inject â€” names only, never values.
      #    This is a pure diagnostic step. It does NOT fail on specific names.
      # --------------------------------------------------------------------------
      - name: ğŸ” List Doppler secret names (diagnostic)
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLERDEV }}
        run: |
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo " Doppler CLI version : $(doppler --version)"
          echo " Secrets available   :"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          doppler secrets --only-names 2>&1 | sed 's/^/  ğŸ“Œ /'
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo " ğŸ‘† Dagger will need: TAILSCALE_AUTH_KEY + KUBECONFIG_BASE64"
          echo " If either is missing above, add it in your Doppler project."

      # --------------------------------------------------------------------------
      # 6. Run the Dagger pipeline.
      #
      #    HOW SECRETS FLOW:
      #      DOPPLERDEV (GitHub Secret) â†’ authenticates the Doppler CLI
      #      `doppler run --`           â†’ injects ALL Doppler project secrets
      #                                   as plain env vars into the child process
      #      env:TAILSCALE_AUTH_KEY     â†’ Dagger reads that env var and wraps it
      #                                   as a Dagger Secret (never logged)
      #
      #    DAGGER_LOG_FORMAT=plain forces readable line-by-line output in GH logs.
      # --------------------------------------------------------------------------
      - name: ğŸ—ï¸ Run Dagger Pipeline (via Doppler)
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLERDEV }}
          DAGGER_LOG_FORMAT: plain
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
        run: |
          set -euo pipefail

          PROGRESS_FLAG="--progress=auto"
          if [ "$DEBUG_MODE" = "true" ]; then
            PROGRESS_FLAG="--progress=plain"
            echo "ğŸ› Debug mode ON â€” full Dagger layer output enabled"
          fi

          echo "ğŸš€ Handing off to Doppler... all project secrets will be injected automatically."

          # doppler run -- exports every secret from your project as an env var.
          # The child process inherits them all â€” no manual mapping needed.
          doppler run -- dagger call $PROGRESS_FLAG \
            --mod ./.ci \
            actions \
            generate-vela-schemas \
              --tailscale-auth-key env:TAILSCALE_AUTH_KEY \
              --kubeconfig-base64  env:KUBECONFIG_BASE64 \
            export \
              --path ./schemas/kubevela

          echo "âœ… Dagger pipeline finished."

      # --------------------------------------------------------------------------
      # 7. Show schema output â€” always runs (even on pipeline failure)
      # --------------------------------------------------------------------------
      - name: ğŸ“‹ Inspect generated schemas
        if: always()
        run: |
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“‚ Schema output: ./schemas/kubevela/"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ -d "./schemas/kubevela" ]; then
            find ./schemas/kubevela -type f | sort | while read -r f; do
              SIZE=$(wc -c < "$f")
              echo "  ğŸ“„ $f  (${SIZE} bytes)"
            done
            TOTAL=$(find ./schemas/kubevela -type f | wc -l)
            echo ""
            echo "  ğŸ—‚ï¸  Total: $TOTAL file(s)"
          else
            echo "  âš ï¸  Directory not found â€” pipeline did not produce output."
            echo "      Check the 'Run Dagger Pipeline' step above."
          fi

      # --------------------------------------------------------------------------
      # 8. Commit & push generated schemas back to the repo
      # --------------------------------------------------------------------------
      - name: ğŸ“ Commit generated schemas
        if: |
          success() && (
            github.event_name == 'push' ||
            (github.event_name == 'workflow_dispatch' && inputs.commit_schemas == true)
          )
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add schemas/kubevela/

          if git diff --cached --quiet; then
            echo "âœ… No schema changes â€” nothing to commit."
          else
            CHANGED=$(git diff --cached --name-only | wc -l)
            TIMESTAMP=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
            git commit -m "ci: regenerate KubeVela schemas [${TIMESTAMP}] (${CHANGED} files)"
            git push
            echo "ğŸš€ Pushed ${CHANGED} schema file(s)."
          fi
